<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SmartSupport â€” Routing Engine</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --border: #1e1e2e;
    --amber: #f5a623;
    --green: #00ff88;
    --red: #ff4757;
    --blue: #4ecdc4;
    --muted: #444466;
    --text: #cccce0;
    --text-dim: #666688;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    pointer-events: none;
    z-index: 1000;
  }

  header {
    border-bottom: 1px solid var(--border);
    padding: 14px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-size: 17px;
    font-weight: 800;
    color: #fff;
  }
  .logo span { color: var(--amber); }

  .status-bar { display: flex; gap: 20px; align-items: center; font-size: 11px; color: var(--text-dim); }
  .status-dot { display: flex; align-items: center; gap: 6px; }

  .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--muted);
  }
  .dot.green { background: var(--green); box-shadow: 0 0 6px var(--green); animation: pulse 2s infinite; }
  .dot.red   { background: var(--red);   box-shadow: 0 0 6px var(--red); }
  .dot.amber { background: var(--amber); box-shadow: 0 0 6px var(--amber); animation: pulse 2s infinite; }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* Stats */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1px;
    background: var(--border);
    border-bottom: 1px solid var(--border);
  }
  .stat-card { background: var(--surface); padding: 18px 22px; }
  .stat-label { font-size: 10px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
  .stat-value { font-size: 26px; font-weight: 700; color: #fff; font-family: 'Syne', sans-serif; line-height: 1; }
  .stat-value.green  { color: var(--green); }
  .stat-value.amber  { color: var(--amber); }
  .stat-value.red    { color: var(--red); }
  .stat-value.blue   { color: var(--blue); }
  .stat-value.orange { color: #ff6b35; }
  .stat-sub { font-size: 10px; color: var(--text-dim); margin-top: 4px; }

  /* Main layout */
  .layout {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 1px;
    background: var(--border);
    height: calc(100vh - 57px - 73px);
  }

  /* Left panel */
  .left-panel {
    background: var(--surface);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .panel-header {
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .tag {
    background: var(--border);
    padding: 2px 7px;
    border-radius: 2px;
    font-size: 9px;
    color: var(--text-dim);
  }

  .form-area { padding: 16px; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }

  textarea {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    padding: 12px;
    resize: none;
    height: 90px;
    outline: none;
    transition: border-color 0.2s;
    border-radius: 2px;
  }
  textarea:focus { border-color: var(--amber); }
  textarea::placeholder { color: var(--muted); }

  .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

  button {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 10px 12px;
    border: 1px solid;
    cursor: pointer;
    transition: all 0.15s;
    border-radius: 2px;
  }
  .btn-primary  { background: var(--amber); border-color: var(--amber); color: #000; }
  .btn-primary:hover { background: #ffc14d; }
  .btn-secondary { background: transparent; border-color: var(--border); color: var(--text-dim); }
  .btn-secondary:hover { border-color: var(--blue); color: var(--blue); }
  .btn-storm { background: transparent; border-color: var(--border); color: var(--text-dim); grid-column: 1/-1; }
  .btn-storm:hover { border-color: #ff6b35; color: #ff6b35; }
  button:disabled { opacity: 0.5; pointer-events: none; }

  .response-box {
    margin: 0 16px;
    background: var(--bg);
    border: 1px solid var(--border);
    padding: 10px 12px;
    font-size: 11px;
    color: var(--text-dim);
    border-radius: 2px;
    min-height: 36px;
    display: none;
    word-break: break-all;
  }
  .response-box.show { display: block; }
  .response-box.ok   { border-color: var(--green); color: var(--green); }
  .response-box.err  { border-color: var(--red);   color: var(--red); }

  /* Circuit breaker */
  .cb-area { padding: 14px 16px; border-top: 1px solid var(--border); flex-shrink: 0; }
  .cb-card {
    display: flex; align-items: center; gap: 10px;
    background: var(--bg); border: 1px solid var(--border);
    padding: 12px; border-radius: 2px; transition: border-color 0.3s;
  }
  .cb-card.open   { border-color: var(--red); }
  .cb-card.closed { border-color: var(--green); }
  .cb-text strong { color: #fff; font-size: 12px; }
  .cb-text small  { display: block; font-size: 10px; color: var(--text-dim); margin-top: 2px; }
  .cb-hint { font-size: 10px; color: var(--text-dim); line-height: 1.7; margin-top: 8px; }

  /* Category bars */
  .cat-area { padding: 14px 16px; border-top: 1px solid var(--border); flex-shrink: 0; }
  .cat-row  { margin-bottom: 10px; }
  .cat-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 5px; }
  .cat-bar  { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .cat-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }

  /* Right: live feed */
  .right-panel { background: var(--surface); display: flex; flex-direction: column; overflow: hidden; }

  .ticket-feed { flex: 1; overflow-y: auto; }

  .ticket-item {
    padding: 11px 18px;
    border-bottom: 1px solid var(--border);
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    animation: slideIn 0.25s ease;
    transition: background 0.15s;
  }
  .ticket-item:hover { background: rgba(255,255,255,0.015); }

  @keyframes slideIn { from{opacity:0;transform:translateX(-6px)} to{opacity:1;transform:translateX(0)} }

  .t-text { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .t-meta { font-size: 10px; color: var(--text-dim); margin-top: 3px; display: flex; gap: 10px; flex-wrap: wrap; }
  .t-bar  { height: 2px; background: var(--border); border-radius: 2px; margin-top: 5px; overflow: hidden; }
  .t-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }

  .badge {
    font-size: 9px; font-weight: 600; letter-spacing: 1px;
    padding: 2px 6px; border-radius: 2px; text-transform: uppercase;
    white-space: nowrap;
  }
  .b-billing   { background:rgba(78,205,196,.15);  color:var(--blue);  border:1px solid rgba(78,205,196,.3); }
  .b-technical { background:rgba(245,166,35,.15);  color:var(--amber); border:1px solid rgba(245,166,35,.3); }
  .b-legal     { background:rgba(255,71,87,.15);   color:var(--red);   border:1px solid rgba(255,71,87,.3); }
  .b-storm     { background:rgba(255,107,53,.15);  color:#ff6b35;      border:1px solid rgba(255,107,53,.3); }

  .time-tag { font-size: 9px; color: var(--text-dim); white-space: nowrap; }
  .empty    { padding: 60px 20px; text-align: center; color: var(--muted); font-size: 11px; letter-spacing: 1px; }

  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>

<header>
  <div class="logo">Smart<span>Support</span> <span style="color:var(--text-dim);font-size:12px;font-weight:400">/ Routing Engine</span></div>
  <div class="status-bar">
    <div class="status-dot"><div class="dot" id="api-dot"></div><span id="api-lbl">connecting...</span></div>
    <div class="status-dot"><div class="dot" id="worker-dot"></div><span id="worker-lbl">worker</span></div>
    <div class="status-dot"><div class="dot" id="cb-dot"></div><span id="cb-lbl">circuit</span></div>
    <span style="color:var(--muted)">|</span>
    <span id="clock" style="color:var(--text-dim)"></span>
  </div>
</header>

<!-- Stats -->
<div class="stats-row">
  <div class="stat-card">
    <div class="stat-label">Submitted</div>
    <div class="stat-value amber" id="s-submitted">0</div>
    <div class="stat-sub">this session</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Queue Depth</div>
    <div class="stat-value" id="s-queue">0</div>
    <div class="stat-sub">pending in redis</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Circuit Breaker</div>
    <div class="stat-value green" id="s-circuit">CLOSED</div>
    <div class="stat-sub">ml model status</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Storms</div>
    <div class="stat-value orange" id="s-storms">0</div>
    <div class="stat-sub">master incidents</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Webhooks</div>
    <div class="stat-value blue" id="s-webhooks">0</div>
    <div class="stat-sub">urgency &gt; 0.8 â†’ discord</div>
  </div>
</div>

<!-- Layout -->
<div class="layout">

  <!-- LEFT -->
  <div class="left-panel">
    <div class="panel-header">Submit Ticket <span class="tag">POST /ticket</span></div>

    <div class="form-area">
      <textarea id="t-input" placeholder="Describe the issue...
e.g. 'Server completely down ASAP!'
     'Invoice charged twice'
     'Need legal contract review'"></textarea>
      <div class="btn-grid">
        <button class="btn-primary" id="btn-submit" onclick="submitTicket()">â–¶ Submit</button>
        <button class="btn-secondary" onclick="submitRandom()">âš¡ Random</button>
      </div>
      <div class="btn-grid">
        <button class="btn-secondary" onclick="checkHealth()">â™¥ Health</button>
        <button class="btn-secondary" onclick="clearFeed()">âœ• Clear Feed</button>
      </div>
      <button class="btn-storm" onclick="triggerStorm()">ðŸŒŠ Trigger Storm (11 tickets)</button>
    </div>

    <div class="response-box" id="resp"></div>

    <!-- Circuit Breaker -->
    <div class="cb-area">
      <div class="panel-header" style="padding:0 0 10px;border:none">Circuit Breaker <span class="tag">auto</span></div>
      <div class="cb-card closed" id="cb-card">
        <div class="dot green" id="cb-bigdot" style="width:10px;height:10px;flex-shrink:0"></div>
        <div class="cb-text">
          <strong id="cb-state">CLOSED</strong>
          <small id="cb-desc">Transformer model operating normally</small>
        </div>
      </div>
      <div class="cb-hint">
        Opens after <span style="color:var(--amber)">3 slow calls &gt;500ms</span> â†’ TF-IDF fallback<br/>
        Closes after <span style="color:var(--green)">5 fast calls &lt;200ms</span> â†’ Transformer restored
      </div>
    </div>

    <!-- Category bars -->
    <div class="cat-area">
      <div class="panel-header" style="padding:0 0 10px;border:none">Category Breakdown <span class="tag">session</span></div>
      <div class="cat-row">
        <div class="cat-label"><span style="color:var(--amber)">Technical</span><span id="p-tech">0%</span></div>
        <div class="cat-bar"><div class="cat-fill" id="b-tech" style="width:0%;background:var(--amber)"></div></div>
      </div>
      <div class="cat-row">
        <div class="cat-label"><span style="color:var(--blue)">Billing</span><span id="p-bill">0%</span></div>
        <div class="cat-bar"><div class="cat-fill" id="b-bill" style="width:0%;background:var(--blue)"></div></div>
      </div>
      <div class="cat-row">
        <div class="cat-label"><span style="color:var(--red)">Legal</span><span id="p-legal">0%</span></div>
        <div class="cat-bar"><div class="cat-fill" id="b-legal" style="width:0%;background:var(--red)"></div></div>
      </div>
    </div>
  </div>

  <!-- RIGHT: live feed -->
  <div class="right-panel">
    <div class="panel-header">
      Live Ticket Feed
      <span class="tag" id="feed-count">0 tickets</span>
    </div>
    <div class="ticket-feed" id="feed">
      <div class="empty">No tickets yet â€” submit one to get started</div>
    </div>
  </div>

</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const st = { submitted: 0, storms: 0, webhooks: 0, cats: {Technical:0, Billing:0, Legal:0}, seenIds: new Set() };

const RANDOMS = [
  "Server is completely down ASAP! Nothing is working!",
  "My invoice was charged twice this month, need refund",
  "We need urgent legal review of our enterprise contract",
  "Cannot login to my account since yesterday morning",
  "Billing portal is broken and I cannot make payment",
  "Database keeps crashing every 10 minutes â€” critical!",
  "CRITICAL production outage all customers affected",
  "Payment failed three times, please help urgently",
  "Legal advice needed on data privacy compliance",
  "API returning 500 errors for all requests â€” fix now",
];

// â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(() => { document.getElementById('clock').textContent = new Date().toLocaleTimeString(); }, 1000);
document.getElementById('clock').textContent = new Date().toLocaleTimeString();

// â”€â”€ Response box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResp(msg, type='ok') {
  const el = document.getElementById('resp');
  el.textContent = msg;
  el.className = `response-box show ${type}`;
  clearTimeout(el._t);
  el._t = setTimeout(() => el.className = 'response-box', 5000);
}

// â”€â”€ Add to feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addToFeed(ticket) {
  if (st.seenIds.has(ticket.id)) return;
  st.seenIds.add(ticket.id);

  const feed = document.getElementById('feed');
  const empty = feed.querySelector('.empty');
  if (empty) empty.remove();

  const cat = ticket.category || 'Technical';
  const u   = parseFloat(ticket.urgency_score) || 0;
  const isDup = ticket.is_duplicate;
  const color = u > 0.8 ? 'var(--red)' : u > 0.5 ? 'var(--amber)' : 'var(--green)';
  const badgeCls = isDup ? 'b-storm' : cat === 'Billing' ? 'b-billing' : cat === 'Legal' ? 'b-legal' : 'b-technical';
  const badgeTxt = isDup ? 'ðŸŒŠ STORM' : cat.toUpperCase();
  const time = new Date().toLocaleTimeString();

  const el = document.createElement('div');
  el.className = 'ticket-item';
  el.innerHTML = `
    <div style="min-width:0">
      <div class="t-text">${escHtml(ticket.text || '')}</div>
      <div class="t-meta">
        <span>#${(ticket.id||'').slice(0,8)}</span>
        ${ticket.assigned_agent ? `<span>â†’ ${ticket.assigned_agent}</span>` : ''}
        ${u ? `<span style="color:${color}">urgency: ${u.toFixed(2)}</span>` : ''}
      </div>
      ${u ? `<div class="t-bar"><div class="t-fill" style="width:${u*100}%;background:${color}"></div></div>` : ''}
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0">
      <span class="badge ${badgeCls}">${badgeTxt}</span>
      <span class="time-tag">${time}</span>
    </div>`;

  feed.insertBefore(el, feed.firstChild);
  while (feed.children.length > 60) feed.removeChild(feed.lastChild);

  // Update counters
  const count = feed.querySelectorAll('.ticket-item').length;
  document.getElementById('feed-count').textContent = `${count} tickets`;

  if (!isDup && cat) {
    st.cats[cat] = (st.cats[cat]||0) + 1;
    updateCats();
  }
  if (isDup) { st.storms++; document.getElementById('s-storms').textContent = st.storms; }
  if (u > 0.8 && !isDup) { st.webhooks++; document.getElementById('s-webhooks').textContent = st.webhooks; }
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function updateCats() {
  const total = Object.values(st.cats).reduce((a,b)=>a+b,0);
  if (!total) return;
  [['Technical','tech'],['Billing','bill'],['Legal','legal']].forEach(([cat,key])=>{
    const pct = Math.round((st.cats[cat]||0)/total*100);
    document.getElementById(`p-${key}`).textContent = pct+'%';
    document.getElementById(`b-${key}`).style.width = pct+'%';
  });
}

function clearFeed() {
  const feed = document.getElementById('feed');
  feed.innerHTML = '<div class="empty">Feed cleared â€” submit a new ticket</div>';
  // Keep seenIds intact â€” prevents poll from re-adding already-seen tickets
  // Only reset the visual counter
  document.getElementById('feed-count').textContent = '0 tickets';
}

// â”€â”€ Health poll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pollHealth() {
  try {
    const r = await fetch('/health');
    const d = await r.json();
    document.getElementById('api-dot').className = 'dot green';
    document.getElementById('api-lbl').textContent = 'api online';

    const q = d.queue_depth || 0;
    document.getElementById('s-queue').textContent = q;
    document.getElementById('worker-dot').className = q > 0 ? 'dot amber' : 'dot green';
    document.getElementById('worker-lbl').textContent = q > 0 ? `${q} queued` : 'worker idle';

    const open = d.circuit_breaker === 'open';
    document.getElementById('s-circuit').textContent = open ? 'OPEN' : 'CLOSED';
    document.getElementById('s-circuit').className = `stat-value ${open ? 'red' : 'green'}`;
    document.getElementById('cb-dot').className = `dot ${open ? 'red' : 'green'}`;
    document.getElementById('cb-lbl').textContent = open ? 'fallback' : 'closed';
    document.getElementById('cb-card').className = `cb-card ${open ? 'open' : 'closed'}`;
    document.getElementById('cb-bigdot').className = `dot ${open ? 'red' : 'green'}`;
    document.getElementById('cb-bigdot').style.cssText = `width:10px;height:10px;flex-shrink:0;background:${open?'var(--red)':'var(--green)'};box-shadow:0 0 6px ${open?'var(--red)':'var(--green)'}`;
    document.getElementById('cb-state').textContent = open ? 'OPEN' : 'CLOSED';
    document.getElementById('cb-desc').textContent = open
      ? 'Using TF-IDF fallback (latency > 500ms)'
      : 'Transformer model operating normally';
  } catch {
    document.getElementById('api-dot').className = 'dot red';
    document.getElementById('api-lbl').textContent = 'api offline';
  }
}
setInterval(pollHealth, 2500);
pollHealth();

// â”€â”€ Poll recent tickets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pollRecent() {
  try {
    const r = await fetch('/tickets/recent');
    if (!r.ok) return;
    const tickets = await r.json();
    // Only add NEW tickets not already shown
    tickets.forEach(t => addToFeed(t));
  } catch { /* endpoint might not exist */ }
}
setInterval(pollRecent, 3000);

// â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitTicket() {
  const text = document.getElementById('t-input').value.trim();
  if (!text) { showResp('âš  Enter ticket text first', 'err'); return; }

  const btn = document.getElementById('btn-submit');
  btn.disabled = true;
  btn.textContent = 'â³ Sending...';

  try {
    const r = await fetch('/ticket', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({text})
    });
    const d = await r.json();
    st.submitted++;
    document.getElementById('s-submitted').textContent = st.submitted;
    document.getElementById('t-input').value = '';

    if (r.status === 202) {
      showResp(`âœ“ Queued â€” #${d.ticket_id.slice(0,8)} â€” processing in background`, 'ok');
    } else {
      addToFeed({...d, text});
      showResp(`âœ“ Done â€” ${d.category} | urgency: ${(d.urgency_score||0).toFixed(2)}`, 'ok');
    }
  } catch(e) {
    showResp('âœ— Cannot reach API â€” is it running?', 'err');
  } finally {
    btn.disabled = false;
    btn.textContent = 'â–¶ Submit';
  }
}

function submitRandom() {
  document.getElementById('t-input').value = RANDOMS[Math.floor(Math.random()*RANDOMS.length)];
  document.getElementById('t-input').focus();
}

async function checkHealth() {
  try {
    const r = await fetch('/health');
    const d = await r.json();
    showResp(`â™¥ OK â€” queue: ${d.queue_depth} | circuit: ${d.circuit_breaker}`, 'ok');
  } catch {
    showResp('âœ— API unreachable', 'err');
  }
}

async function triggerStorm() {
  const stormTexts = [
    "Server is completely down","Server is totally down",
    "The server is down and not working","Server down nothing works",
    "Everything is down server unreachable","Server is not responding at all",
    "Server has been down for an hour","Our server is down please fix",
    "Server completely unreachable","Nothing is working server is down",
    "Server down ASAP please help",
  ];
  showResp('ðŸŒŠ Firing 11 storm tickets simultaneously...', 'ok');
  st.submitted += 11;
  document.getElementById('s-submitted').textContent = st.submitted;

  await Promise.all(stormTexts.map((text, i) =>
    fetch('/ticket', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({id:`storm-${i}-${Date.now()}`, text})
    }).catch(()=>{})
  ));
  showResp('ðŸŒŠ Storm fired â€” watch feed for Master Incident', 'ok');
}

// Enter + Ctrl to submit
document.getElementById('t-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && e.ctrlKey) submitTicket();
});
</script>
</body>
</html>
